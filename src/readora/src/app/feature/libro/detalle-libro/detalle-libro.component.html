<div class="container mt-4">
  <!-- Indicador de carga -->
  <div class="text-center my-5" *ngIf="loading">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>

  <!-- Mensaje de error -->
  <div class="alert alert-danger" *ngIf="error">
    {{ error }}
    <button class="btn btn-link" (click)="reloadLibro()">
      Intentar de nuevo
    </button>
  </div>

  <!-- Detalles del libro -->
  <div class="card shadow-sm" *ngIf="libro && !loading">
    <div class="row g-0">
      <!-- Portada del libro -->
      <div class="col-md-4">
        <div class="text-center p-3">
          <img [src]="getPortadaUrl(libro.portadaUrl)" 
               alt="Portada de {{ libro.titulo }}" 
               class="book-cover-standard">
          
          <div class="mt-3 d-flex justify-content-center gap-2">
            <!-- Botón para añadir a biblioteca (visible cuando no está en la biblioteca) -->
            <button class="btn btn-primary btn-sm" 
                    *ngIf="isLoggedIn && !enBiblioteca" 
                    (click)="agregarABiblioteca()"
                    [disabled]="agregando">
              <ng-container *ngIf="!agregando">
                <i class="bi bi-bookmark-plus me-1"></i> Añadir a mi biblioteca
              </ng-container>
              <ng-container *ngIf="agregando">
                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                Añadiendo...
              </ng-container>
            </button>
            
            <!-- Botón para eliminar de biblioteca (visible cuando está en la biblioteca) -->
            <button class="btn btn-outline-danger btn-sm"
                    *ngIf="isLoggedIn && enBiblioteca"
                    (click)="eliminarDeColeccion()"
                    [disabled]="eliminando">
              <ng-container *ngIf="!eliminando">
                <i class="bi bi-trash me-1"></i> Eliminar de mi biblioteca
              </ng-container>
              <ng-container *ngIf="eliminando">
                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                Eliminando...
              </ng-container>
            </button>
            
            <!-- Botón para iniciar sesión (solo visible cuando no hay sesión) -->
            <button class="btn btn-outline-secondary btn-sm" 
                    *ngIf="!isLoggedIn" 
                    routerLink="/api/v1/authenticate" 
                    [queryParams]="{returnUrl: '/libros/' + libroId}">
              <i class="bi bi-box-arrow-in-right me-1"></i> Iniciar sesión para añadir
            </button>
          </div>
        </div>
      </div>
      
      <!-- Información del libro -->
      <div class="col-md-8">
        <div class="card-body">
          <h1 class="card-title">{{ libro.titulo }}</h1>
          
          <!-- Mostrar múltiples autores -->
          <h4 class="card-subtitle mb-3 text-muted" *ngIf="autores && autores.length > 0">
            <span>por </span>
            <ng-container *ngFor="let autor of autores; let last = last; let i = index">
              <a [routerLink]="['/autores', autor.id]" class="author-link">
                {{ autor.nombre }} {{ autor.apellido }}
              </a>
              <ng-container *ngIf="!last">
                <ng-container *ngIf="i < autores.length - 2">, </ng-container>
                <ng-container *ngIf="i === autores.length - 2"> y </ng-container>
              </ng-container>
            </ng-container>
          </h4>
          
          <!-- Mensaje si no hay autores -->
          <h4 class="card-subtitle mb-3 text-muted" *ngIf="!autores || autores.length === 0">
            Autor desconocido
          </h4>
          
          <div class="mb-3">
            <span class="badge bg-primary me-2">{{ libro.genero }}</span>
            <span class="badge bg-secondary me-2">{{ libro.anioPublicacion }}</span>
            <span class="badge bg-info">{{ libro.editorial }}</span>
          </div>
          
          <h5 class="card-subtitle mb-2">Sinopsis</h5>
          <p class="card-text">{{ libro.sinopsis || 'No hay sinopsis disponible para este libro.' }}</p>
          
          <div class="libro-detalles mt-4">
            <table class="table table-striped">
              <tbody>
                <tr>
                  <th>ISBN:</th>
                  <td>{{ libro.isbn || 'No disponible' }}</td>
                </tr>
                <tr>
                  <th>Editorial:</th>
                  <td>{{ libro.editorial || 'No disponible' }}</td>
                </tr>
                <tr>
                  <th>Año de publicación:</th>
                  <td>{{ libro.anioPublicacion || 'No disponible' }}</td>
                </tr>
                <tr>
                  <th>Páginas:</th>
                  <td>{{ libro.numeroPaginas || 'No disponible' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Sección de autores -->
  <div class="card shadow-sm mt-4" *ngIf="autores && autores.length > 0 && !loading">
    <div class="card-body">
      <h3 class="card-title">Autores</h3>
      <div class="row">
        <div class="col-md-4 mb-3" *ngFor="let autor of autores">
          <a [routerLink]="['/autores', autor.id]" class="text-decoration-none">
            <div class="card author-card h-100">
              <div class="row g-0">
                <div class="col-4">
                  <img [src]="getAutorImageUrl(autor.fotoUrl)" 
                       alt="Foto de {{ autor.nombre }}"
                       class="img-fluid rounded-start author-thumbnail">
                </div>
                <div class="col-8">
                  <div class="card-body">
                    <h5 class="card-title">{{ autor.nombre }} {{ autor.apellido }}</h5>
                    <p class="card-text small text-muted" *ngIf="autor.nacionalidad">
                      {{ autor.nacionalidad }}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
