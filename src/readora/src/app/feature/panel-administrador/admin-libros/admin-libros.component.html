<div class="mb-4">
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-3">
    <h2 class="h5 fw-medium text-highlight mb-0">Gestión de Libros</h2>
    
    <div class="d-flex flex-wrap gap-2">
      <!-- Botón para añadir nuevo libro -->
      <button *ngIf="!showForm" (click)="prepareCreateLibro()" 
        class="btn btn-primary btn-sm d-inline-flex align-items-center transition-all">
        <span class="material-icons small me-1">add</span>
        <span>Añadir Libro</span>
      </button>
    </div>
  </div>

  <!-- Formulario para añadir/editar libro -->
  <div *ngIf="showForm" class="card shadow-sm border-0 mb-4">
    <div class="card-header d-flex justify-content-between align-items-center border-bottom">
      <h3 class="h6 fw-medium text-highlight mb-0">{{isEditing ? 'Editar Libro' : 'Añadir Libro'}}</h3>
      <button (click)="cancelEdit()" class="btn-close btn-sm" aria-label="Cerrar"></button>
    </div>
    
    <div class="card-body">
      <form (submit)="saveLibro()" #libroForm="ngForm" class="mb-3">
        <div class="row mb-3">
          <div class="col-12 col-md-8 mb-3 mb-md-0">
            <label for="titulo" class="form-label">Título <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text">
                <span class="material-icons small">book</span>
              </span>
              <input type="text" id="titulo" [(ngModel)]="currentLibro.titulo" name="titulo" 
                class="form-control" 
                required
                #tituloInput="ngModel"
                [ngClass]="{'is-invalid': tituloInput.invalid && (tituloInput.dirty || tituloInput.touched)}">
            </div>
            <div *ngIf="tituloInput.invalid && (tituloInput.dirty || tituloInput.touched)" class="text-danger small mt-1">
              <span *ngIf="tituloInput.errors?.['required']">El título es obligatorio</span>
            </div>
          </div>
          
          <div class="col-12 col-md-4">
            <label for="isbn" class="form-label">ISBN</label>
            <div class="input-group">
              <span class="input-group-text">
                <span class="material-icons small">qr_code</span>
              </span>
              <input type="text" id="isbn" [(ngModel)]="currentLibro.isbn" name="isbn" 
                class="form-control">
            </div>
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-12 col-md-6 mb-3 mb-md-0">
            <label for="anioPublicacion" class="form-label">Fecha de Publicación</label>
            <div class="input-group">
              <span class="input-group-text">
                <span class="material-icons small">event</span>
              </span>
              <input type="date" id="anioPublicacion" [(ngModel)]="currentLibro.anioPublicacion" name="anioPublicacion" 
                class="form-control"
                [max]="getMaxDate()">
            </div>
          </div>
          
          <div class="col-12 col-md-6">
            <label for="numeroPaginas" class="form-label">Número de Páginas</label>
            <div class="input-group">
              <span class="input-group-text">
                <span class="material-icons small">auto_stories</span>
              </span>
              <input type="number" id="numeroPaginas" [(ngModel)]="currentLibro.numeroPaginas" name="numeroPaginas" 
                class="form-control" min="1">
            </div>
          </div>
        </div>
        
        <div class="mb-3">
          <label for="sinopsis" class="form-label">Sinopsis</label>
          <textarea id="sinopsis" [(ngModel)]="currentLibro.sinopsis" name="sinopsis" 
            class="form-control" rows="3"
            #sinopsisInput="ngModel"
            maxlength="1000"
            [ngClass]="{'is-invalid': sinopsisInput.invalid && (sinopsisInput.dirty || sinopsisInput.touched)}">
          </textarea>
          <div *ngIf="sinopsisInput.invalid && (sinopsisInput.dirty || sinopsisInput.touched)" class="text-danger small mt-1">
            <span *ngIf="sinopsisInput.errors?.['maxlength']">La sinopsis no puede tener más de 1000 caracteres</span>
          </div>
          <small class="text-muted">Breve descripción del libro (máx. 1000 caracteres)</small>
        </div>

        <div class="row mb-3">
          <div class="col-12 col-md-6">
            <label for="portada" class="form-label">Portada del libro</label>
            <div class="d-flex gap-3 align-items-start">
              <!-- Vista previa de la imagen actual si existe -->
              <div *ngIf="previewPortadaUrl" class="mb-2" style="max-width: 100px;">
                <img [src]="previewPortadaUrl" alt="Vista previa de portada" class="img-fluid rounded">
              </div>
              <div class="flex-grow-1">
                <input type="file" class="form-control" id="portada" (change)="onFileSelected($event)" accept="image/*">
                <small class="text-muted">Formatos aceptados: JPG, PNG (Máx. 2 MB)</small>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Autores asociados al libro -->
        <div class="mb-3">
          <label class="form-label">Autores</label>
          
          <div class="d-flex flex-column gap-2">
            <!-- Lista de autores actuales -->
            <div *ngIf="currentLibro.autores?.length > 0" class="mb-2">
              <div *ngFor="let autor of currentLibro.autores" class="badge bg-primary bg-opacity-10 text-primary me-2 mb-2 p-2 d-inline-flex align-items-center">
                {{autor.nombre}} {{autor.apellido}}
                <button type="button" class="btn-close btn-close-sm ms-2" (click)="removeAutor(autor)"></button>
              </div>
            </div>
            
            <!-- Mensaje si no hay autores -->
            <div *ngIf="!currentLibro.autores?.length" class="text-muted small mb-2">
              No hay autores asociados a este libro
            </div>
            
            <!-- Botón para añadir autor -->
            <button type="button" class="btn btn-outline-primary btn-sm d-inline-flex align-items-center align-self-start" (click)="showAutorSelector()">
              <span class="material-icons small me-1">person_add</span>
              <span>Añadir autor</span>
            </button>
          </div>
        </div>
        
        <div class="d-flex gap-2 mt-4">
          <button type="submit" [disabled]="libroForm.invalid || isUploading"
            class="btn btn-primary btn-sm d-inline-flex align-items-center transition-all">
            <span class="material-icons small me-1">save</span>
            <span *ngIf="!isUploading">Guardar</span>
            <span *ngIf="isUploading">Guardando...</span>
          </button>
          <button type="button" (click)="cancelEdit()" 
            class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center transition-all">
            <span class="material-icons small me-1">close</span>
            <span>Cancelar</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Tabla de libros -->
  <div class="table-responsive">
    <table class="table table-hover table-striped">
      <thead class="table-light">
        <tr>
          <th scope="col" class="text-primary small">ID</th>
          <th scope="col" class="text-primary small">Portada</th>
          <th scope="col" class="text-primary small">Título</th>
          <th scope="col" class="text-primary small">ISBN</th>
          <th scope="col" class="text-primary small">Autores</th>
          <th scope="col" class="text-primary small">Páginas</th>
          <th scope="col" class="text-primary small">Publicación</th>
          <th scope="col" class="text-primary small text-center">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let libro of libros">
          <td class="small text-secondary">
            {{libro.id}}
          </td>
          <td>
            <img [src]="libro.portadaUrl ? getImageUrl(libro.portadaUrl) : '/assets/placeholder-book.jpg'" 
              alt="Portada de {{libro.titulo}}" 
              class="img-thumbnail" 
              style="height: 50px; width: auto;">
          </td>
          <td>
            {{libro.titulo}}
          </td>
          <td>
            {{libro.isbn || 'N/A'}}
          </td>
          <td class="small">
            <!-- Mostrar hasta 2 autores -->
            <span *ngFor="let autor of libro.autores?.slice(0, 2); let i = index">
              {{autor.nombre}} {{autor.apellido}}{{i < ((libro.autores && libro.autores.length > 2) ? 2 : (libro.autores ? libro.autores.length : 0)) - 1 ? ', ' : ''}}
            </span>
            <!-- Indicar si hay más autores -->
            <span *ngIf="libro.autores && libro.autores.length > 2" class="text-muted"> y {{libro.autores.length - 2}} más</span>
            <!-- Si no hay autores -->
            <span *ngIf="!libro.autores?.length" class="text-muted">Sin autores</span>
          </td>
          <td class="text-center">
            {{libro.numeroPaginas || 'N/A'}}
          </td>
          <td>
            {{libro.anioPublicacion ? (libro.anioPublicacion | date:'yyyy') : 'N/A'}}
          </td>
          <td class="text-center">
            <div class="d-flex justify-content-center gap-2">
              <button (click)="prepareUpdateLibro(libro)" 
                class="btn btn-sm btn-outline-primary border-0 transition-all" title="Editar">
                <span class="material-icons small">edit</span>
              </button>
              <button (click)="deleteLibro(libro.id)" 
                class="btn btn-sm btn-outline-danger border-0 transition-all" title="Eliminar">
                <span class="material-icons small">delete</span>
              </button>
            </div>
          </td>
        </tr>
        
        <!-- Mensaje cuando no hay libros -->
        <tr *ngIf="libros.length === 0">
          <td colspan="8" class="text-center text-secondary py-4">
            No hay libros disponibles
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <!-- Paginación -->
  <div *ngIf="totalPages > 0" class="d-flex justify-content-center mt-3">
    <nav>
      <ul class="pagination pagination-sm">
        <li class="page-item" [class.disabled]="currentPage <= 0">
          <button class="page-link" (click)="changePage(currentPage - 1)" aria-label="Anterior">
            <span class="material-icons small">navigate_before</span>
          </button>
        </li>
        
        <li class="page-item" *ngFor="let page of [].constructor(totalPages < 5 ? totalPages : 5); let i = index" [class.active]="currentPage === i">
          <button class="page-link" (click)="changePage(i)">
            {{i + 1}}
          </button>
        </li>
        
        <li class="page-item disabled" *ngIf="totalPages > 5">
          <span class="page-link">...</span>
        </li>
        
        <li class="page-item" [class.disabled]="currentPage >= totalPages - 1">
          <button class="page-link" (click)="changePage(currentPage + 1)" aria-label="Siguiente">
            <span class="material-icons small">navigate_next</span>
          </button>
        </li>
      </ul>
    </nav>
  </div>
  
  <!-- Modal para seleccionar autores -->
  <div *ngIf="showAutorSelectorModal" class="modal d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Seleccionar autor</h5>
          <button type="button" class="btn-close" (click)="showAutorSelectorModal = false"></button>
        </div>
        <div class="modal-body">
          <div *ngIf="allAutores.length === 0" class="alert alert-info">
            No hay autores disponibles. Crea un autor primero.
          </div>
          
          <div *ngIf="allAutores.length > 0" class="form-group">
            <label for="autorSelector" class="form-label">Autor</label>
            <select [(ngModel)]="selectedAutorId" class="form-select" id="autorSelector">
              <option [ngValue]="null" disabled>-- Selecciona un autor --</option>
              <option *ngFor="let autor of allAutores" [ngValue]="autor.id">
                {{autor.nombre}} {{autor.apellido}}
              </option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="showAutorSelectorModal = false">Cancelar</button>
          <button type="button" class="btn btn-primary" (click)="selectAutor()" [disabled]="!selectedAutorId">Añadir</button>
        </div>
      </div>
    </div>
  </div>
</div>
