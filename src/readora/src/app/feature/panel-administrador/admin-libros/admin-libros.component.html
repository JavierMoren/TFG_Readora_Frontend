<div class="mb-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h5 fw-medium text-highlight mb-0">Gestión de Libros</h2>
    
    <!-- Botón para añadir nuevo libro -->
    <button *ngIf="!showForm" (click)="prepareCreateLibro()" 
      class="btn btn-primary btn-sm d-inline-flex align-items-center transition-all">
      <span class="material-icons small me-1">add</span>
      <span>Añadir Libro</span>
    </button>
  </div>

  <!-- Formulario para añadir/editar libro -->
  <div *ngIf="showForm" class="card shadow-sm border-0 mb-4">
    <div class="card-header d-flex justify-content-between align-items-center border-bottom">
      <h3 class="h6 fw-medium text-highlight mb-0">{{isEditing ? 'Editar Libro' : 'Añadir Libro'}}</h3>
      <button (click)="cancelEdit()" class="btn-close btn-sm" aria-label="Cerrar"></button>
    </div>
    
    <div class="card-body">
      <form (submit)="saveLibro()" #libroForm="ngForm">
        <div class="row mb-3">
          <div class="col-12 col-md-6 mb-3 mb-md-0">
            <label for="titulo" class="form-label">Título <span class="text-danger">*</span></label>
            <input type="text" id="titulo" [(ngModel)]="currentLibro.titulo" name="titulo" 
              class="form-control" 
              required
              #tituloInput="ngModel"
              minlength="2"
              maxlength="200"
              [ngClass]="{'is-invalid': tituloInput.invalid && (tituloInput.dirty || tituloInput.touched)}">
            <div *ngIf="tituloInput.invalid && (tituloInput.dirty || tituloInput.touched)" class="invalid-feedback">
              <span *ngIf="tituloInput.errors?.['required']">El título es obligatorio</span>
              <span *ngIf="tituloInput.errors?.['minlength']">El título debe tener al menos 2 caracteres</span>
              <span *ngIf="tituloInput.errors?.['maxlength']">El título no puede tener más de 200 caracteres</span>
            </div>
          </div>
          
          <div class="col-12 col-md-6">
            <label for="isbn" class="form-label">ISBN</label>
            <input type="text" id="isbn" [(ngModel)]="currentLibro.isbn" name="isbn" 
              class="form-control"
              #isbnInput="ngModel"
              [ngClass]="{'is-invalid': isbnInput.invalid && (isbnInput.dirty || isbnInput.touched)}"
              pattern="^(?:(?:978|979)-?)?(?:\d-?){9}[\dXx]$">
            <div *ngIf="isbnInput.invalid && (isbnInput.dirty || isbnInput.touched)" class="invalid-feedback">
              <span *ngIf="isbnInput.errors?.['pattern']">Formato ISBN inválido</span>
            </div>
            <small class="form-text text-secondary">Formato ISBN válido (10 o 13 dígitos)</small>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-12 col-md-6 mb-3 mb-md-0">
            <label for="editorial" class="form-label">Editorial</label>
            <input type="text" id="editorial" [(ngModel)]="currentLibro.editorial" name="editorial" 
              class="form-control"
              #editorialInput="ngModel"
              [ngClass]="{'is-invalid': editorialInput.invalid && (editorialInput.dirty || editorialInput.touched)}"
              maxlength="100">
            <div *ngIf="editorialInput.invalid && (editorialInput.dirty || editorialInput.touched)" class="invalid-feedback">
              <span *ngIf="editorialInput.errors?.['maxlength']">La editorial no puede tener más de 100 caracteres</span>
            </div>
          </div>
          
          <div class="col-12 col-md-6">
            <label for="anioPublicacion" class="form-label">Fecha de Publicación</label>
            <input type="date" id="anioPublicacion" [(ngModel)]="currentLibro.anioPublicacion" name="anioPublicacion" 
              class="form-control"
              #anioPublicacionInput="ngModel"
              [ngClass]="{'is-invalid': anioPublicacionInput.invalid && (anioPublicacionInput.dirty || anioPublicacionInput.touched)}"
              [max]="getMaxDate()">
            <div *ngIf="anioPublicacionInput.invalid && (anioPublicacionInput.dirty || anioPublicacionInput.touched)" class="invalid-feedback">
              <span *ngIf="anioPublicacionInput.errors?.['max']">La fecha no puede ser futura</span>
            </div>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-12 col-md-6 mb-3 mb-md-0">
            <label for="genero" class="form-label">Género</label>
            <input type="text" id="genero" [(ngModel)]="currentLibro.genero" name="genero" 
              class="form-control"
              #generoInput="ngModel"
              [ngClass]="{'is-invalid': generoInput.invalid && (generoInput.dirty || generoInput.touched)}"
              maxlength="50">
            <div *ngIf="generoInput.invalid && (generoInput.dirty || generoInput.touched)" class="invalid-feedback">
              <span *ngIf="generoInput.errors?.['maxlength']">El género no puede tener más de 50 caracteres</span>
            </div>
          </div>
          
          <div class="col-12 col-md-6">
            <label for="numeroPaginas" class="form-label">Número de páginas</label>
            <input type="number" id="numeroPaginas" [(ngModel)]="currentLibro.numeroPaginas" name="numeroPaginas" 
              class="form-control"
              #paginasInput="ngModel"
              [ngClass]="{'is-invalid': paginasInput.invalid && (paginasInput.dirty || paginasInput.touched)}"
              min="1" max="9999">
            <div *ngIf="paginasInput.invalid && (paginasInput.dirty || paginasInput.touched)" class="invalid-feedback">
              <span *ngIf="paginasInput.errors?.['min']">El número de páginas debe ser mayor que 0</span>
              <span *ngIf="paginasInput.errors?.['max']">El número de páginas no puede exceder 9999</span>
            </div>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-12">
            <label for="sinopsis" class="form-label">Sinopsis</label>
            <textarea id="sinopsis" [(ngModel)]="currentLibro.sinopsis" name="sinopsis" 
              class="form-control"
              #sinopsisInput="ngModel"
              [ngClass]="{'is-invalid': sinopsisInput.invalid && (sinopsisInput.dirty || sinopsisInput.touched)}"
              rows="4"
              maxlength="1000"></textarea>
            <div *ngIf="sinopsisInput.invalid && (sinopsisInput.dirty || sinopsisInput.touched)" class="invalid-feedback">
              <span *ngIf="sinopsisInput.errors?.['maxlength']">La sinopsis no puede tener más de 1000 caracteres</span>
            </div>
            <small class="text-muted">Breve descripción del libro (máx. 1000 caracteres)</small>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-12 col-md-6">
            <label for="portada" class="form-label">Portada del libro</label>
            <div class="d-flex gap-3 align-items-start">
              <!-- Vista previa de la imagen actual si existe -->
              <div *ngIf="previewPortadaUrl" class="mb-2" style="max-width: 100px;">
                <img [src]="previewPortadaUrl" alt="Vista previa de portada" class="img-fluid rounded">
              </div>
              <div class="flex-grow-1">
                <input type="file" class="form-control" id="portada" (change)="onFileSelected($event)" accept="image/*">
                <small class="text-muted">Formatos aceptados: JPG, PNG (Máx. 2 MB)</small>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button type="submit" [disabled]="libroForm.invalid"
            class="btn btn-primary btn-sm d-inline-flex align-items-center transition-all">
            <span class="material-icons small me-1">save</span>
            <span>Guardar</span>
          </button>
          <button type="button" (click)="cancelEdit()" 
            class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center transition-all">
            <span class="material-icons small me-1">close</span>
            <span>Cancelar</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Tabla de libros -->
  <div class="table-responsive">
    <table class="table table-hover table-striped">
      <thead class="table-light">
        <tr>
          <th scope="col" class="text-primary small cursor-pointer" (click)="changeSort('id')">
            <div class="d-flex align-items-center">
              <span>ID</span>
              <span *ngIf="sortBy === 'id'" class="material-icons small ms-1">
                {{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
              </span>
            </div>
          </th>
          <th scope="col" class="text-primary small cursor-pointer" (click)="changeSort('titulo')">
            <div class="d-flex align-items-center">
              <span>Título</span>
              <span *ngIf="sortBy === 'titulo'" class="material-icons small ms-1">
                {{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
              </span>
            </div>
          </th>
          <th scope="col" class="text-primary small text-center">Portada</th>
          <th scope="col" class="text-primary small cursor-pointer" (click)="changeSort('isbn')">
            <div class="d-flex align-items-center">
              <span>ISBN</span>
              <span *ngIf="sortBy === 'isbn'" class="material-icons small ms-1">
                {{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
              </span>
            </div>
          </th>
          <th scope="col" class="text-primary small cursor-pointer" (click)="changeSort('editorial')">
            <div class="d-flex align-items-center">
              <span>Editorial</span>
              <span *ngIf="sortBy === 'editorial'" class="material-icons small ms-1">
                {{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
              </span>
            </div>
          </th>
          <th scope="col" class="text-primary small cursor-pointer" (click)="changeSort('numeroPaginas')">
            <div class="d-flex align-items-center">
              <span>Páginas</span>
              <span *ngIf="sortBy === 'numeroPaginas'" class="material-icons small ms-1">
                {{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
              </span>
            </div>
          </th>
          <th scope="col" class="text-primary small">Sinopsis</th>
          <th scope="col" class="text-primary small text-center">
            Acciones
          </th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let libro of libros">
          <td class="small text-secondary">
            {{libro.id}}
          </td>
          <td class="fw-medium">
            {{libro.titulo}}
          </td>
          <td class="text-center">
            <img *ngIf="libro.portadaUrl" [src]="librosService.getImageUrl(libro.portadaUrl)" alt="Portada {{libro.titulo}}" 
                 class="img-thumbnail" style="max-height: 50px; max-width: 40px;">
            <span *ngIf="!libro.portadaUrl" class="text-muted small">Sin portada</span>
          </td>
          <td class="small text-secondary">
            {{libro.isbn || 'No disponible'}}
          </td>
          <td class="small text-secondary">
            {{libro.editorial || 'No disponible'}}
          </td>
          <td class="small text-secondary text-center">
            {{libro.numeroPaginas || 'N/D'}}
          </td>
          <td class="small text-secondary">
            <span *ngIf="libro.sinopsis" title="{{libro.sinopsis}}">
              {{libro.sinopsis | slice:0:40}}{{libro.sinopsis.length > 40 ? '...' : ''}}
            </span>
            <span *ngIf="!libro.sinopsis" class="text-muted">Sin sinopsis</span>
          </td>
          <td class="text-center">
            <div class="d-flex justify-content-center gap-2">
              <button (click)="prepareUpdateLibro(libro)" 
                class="btn btn-sm btn-outline-primary border-0 transition-all" title="Editar">
                <span class="material-icons small">edit</span>
              </button>
              <button (click)="deleteLibro(libro.id)" 
                class="btn btn-sm btn-outline-danger border-0 transition-all" title="Eliminar">
                <span class="material-icons small">delete</span>
              </button>
            </div>
          </td>
        </tr>
        
        <!-- Mensaje cuando no hay libros -->
        <tr *ngIf="libros.length === 0">
          <td colspan="9" class="text-center text-secondary py-4">
            No hay libros disponibles
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Paginación -->
  <div *ngIf="totalPages > 1" class="d-flex justify-content-between align-items-center small">
    <div class="text-secondary">
      Mostrando <span class="fw-medium">{{currentPage * pageSize + 1}}-{{(currentPage + 1) * pageSize > totalElements ? totalElements : (currentPage + 1) * pageSize}}</span> de <span class="fw-medium">{{totalElements}}</span> libros
    </div>
    
    <nav aria-label="Páginas">
      <ul class="pagination pagination-sm mb-0">
        <li class="page-item" [class.disabled]="currentPage === 0">
          <button class="page-link" (click)="changePage(currentPage - 1)" aria-label="Anterior">
            <span class="material-icons small">navigate_before</span>
          </button>
        </li>
        
        <li class="page-item" *ngFor="let page of [].constructor(totalPages < 5 ? totalPages : 5); let i = index" [class.active]="currentPage === i">
          <button class="page-link" (click)="changePage(i)">
            {{i + 1}}
          </button>
        </li>
        
        <li class="page-item disabled" *ngIf="totalPages > 5">
          <span class="page-link">...</span>
        </li>
        
        <li class="page-item" [class.disabled]="currentPage >= totalPages - 1">
          <button class="page-link" (click)="changePage(currentPage + 1)" aria-label="Siguiente">
            <span class="material-icons small">navigate_next</span>
          </button>
        </li>
      </ul>
    </nav>
  </div>
  
  <!-- Modal de confirmación para eliminar -->
  <app-confirm-modal
    [visible]="showConfirmModal"
    [title]="confirmModalTitle"
    [message]="confirmModalMessage"
    confirmButtonText="Eliminar"
    confirmButtonClass="btn-danger"
    cancelButtonText="Cancelar"
    (confirm)="confirmDeleteLibro()"
    (cancel)="cancelDeleteLibro()"
    (close)="showConfirmModal = false">
  </app-confirm-modal>
</div>
