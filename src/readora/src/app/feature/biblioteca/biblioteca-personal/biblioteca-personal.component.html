<div class="container biblioteca-container">
  <div class="biblioteca-header">
    <h1 class="biblioteca-title mb-2" id="biblioteca-title">Mi Biblioteca Personal</h1>
    <p class="biblioteca-subtitle">Organiza y gestiona todas tus lecturas en un solo lugar</p>
  </div>

  <!-- Filtros rediseñados para seleccionar qué libros mostrar -->
  <div class="filtros-container" role="tablist" aria-label="Filtros de biblioteca">
    <div class="filtros-wrapper">
      <button type="button" class="filtro-btn" 
          [class.active]="filtroActual === 'leyendo'" 
          (click)="cambiarFiltro('leyendo')"
          role="tab"
          [attr.aria-selected]="filtroActual === 'leyendo'"
          aria-controls="seccion-leyendo"
          id="tab-leyendo">
          <span class="filtro-icon"><span class="material-icons" aria-hidden="true">auto_stories</span></span>
          <span class="filtro-text">Leyendo</span>
          <span class="filtro-count" [class.has-items]="librosLeyendo.length > 0">{{librosLeyendo.length}}</span>
          <span class="visually-hidden"> libros leyendo</span>
      </button>
      <button type="button" class="filtro-btn" 
          [class.active]="filtroActual === 'pendientes'" 
          (click)="cambiarFiltro('pendientes')"
          role="tab"
          [attr.aria-selected]="filtroActual === 'pendientes'"
          aria-controls="seccion-pendientes"
          id="tab-pendientes">
          <span class="filtro-icon"><span class="material-icons" aria-hidden="true">bookmark</span></span>
          <span class="filtro-text">Por leer</span>
          <span class="filtro-count" [class.has-items]="librosPendientes.length > 0">{{librosPendientes.length}}</span>
          <span class="visually-hidden"> libros por leer</span>
      </button>
      <button type="button" class="filtro-btn" 
          [class.active]="filtroActual === 'terminados'" 
          (click)="cambiarFiltro('terminados')"
          role="tab"
          [attr.aria-selected]="filtroActual === 'terminados'"
          aria-controls="seccion-terminados"
          id="tab-terminados">
          <span class="filtro-icon"><span class="material-icons" aria-hidden="true">check_circle</span></span>
          <span class="filtro-text">Leídos</span>
          <span class="filtro-count" [class.has-items]="librosTerminados.length > 0">{{librosTerminados.length}}</span>
          <span class="visually-hidden"> libros leídos</span>
      </button>
      <button type="button" class="filtro-btn" 
          [class.active]="filtroActual === 'abandonados'" 
          (click)="cambiarFiltro('abandonados')"
          role="tab"
          [attr.aria-selected]="filtroActual === 'abandonados'"
          aria-controls="seccion-abandonados"
          id="tab-abandonados">
          <span class="filtro-icon"><span class="material-icons" aria-hidden="true">cancel</span></span>
          <span class="filtro-text">Abandonados</span>
          <span class="filtro-count" [class.has-items]="librosAbandonados.length > 0">{{librosAbandonados.length}}</span>
          <span class="visually-hidden"> libros abandonados</span>
      </button>
    </div>
  </div>

  <!-- Mensaje cuando no hay libros -->
  <div *ngIf="!librosLeyendo.length && !librosPendientes.length && !librosTerminados.length && !librosAbandonados.length && !cargando"
       class="sin-libros"
       aria-live="polite"
       role="status">
      <div class="sin-libros-icon">
        <span class="material-icons" aria-hidden="true">menu_book</span>
      </div>
      <h3 class="sin-libros-title">Tu biblioteca está vacía</h3>
      <p class="sin-libros-text">
          No tienes libros en tu biblioteca personal. 
          Utiliza el buscador para encontrar libros y añadirlos a tu colección.
      </p>
      <a routerLink="/buscador" class="btn btn-primary mt-3">
        <span class="material-icons me-2">search</span>
        Buscar libros
      </a>
  </div>
  
  <!-- Indicador de carga -->
  <div *ngIf="cargando" class="loading-state" aria-live="polite" role="status">
      <div class="spinner">
          <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando...</span>
          </div>
      </div>
      <p class="loading-text">Cargando tu biblioteca...</p>
  </div>

  <!-- Sección de libros que estoy leyendo -->
  <div *ngIf="(filtroActual === 'leyendo') && librosLeyendo.length > 0" 
       class="biblioteca-section" 
       role="tabpanel" 
       id="seccion-leyendo" 
       aria-labelledby="tab-leyendo">
      
      <div class="section-header">
          <h2 class="section-title">
            <span class="material-icons section-icon" aria-hidden="true">auto_stories</span>
            Estoy leyendo
          </h2>
          <span class="section-count">{{librosLeyendo.length}} {{librosLeyendo.length === 1 ? 'libro' : 'libros'}}</span>
      </div>
      <div class="libros-grid">
          <div class="libro-item" *ngFor="let libro of librosLeyendo">
              <div class="libro-card">
                  <div class="libro-img-container">
                      <img [src]="getImageUrl(libro.portadaUrl)" 
                           class="libro-portada" alt="Portada del libro {{libro.titulo}}">
                      <div class="libro-overlay">
                          <div class="libro-estado-badge" [ngClass]="getColorEstado('LEYENDO')">
                              <span class="material-icons estado-icon">auto_stories</span>
                              <span>Leyendo</span>
                          </div>
                      </div>
                  </div>
                  <div class="libro-info">
                      <h5 class="libro-titulo">{{libro.titulo}}</h5>
                      <div class="libro-autor">
                          <span class="material-icons autor-icon">person</span>
                          <span>{{libro.autor?.nombre}} {{libro.autor?.apellido}}</span>
                      </div>
                      <div class="libro-meta">
                          <div class="meta-item">
                              <span class="meta-label">Inicio:</span>
                              <span class="meta-value">{{formatearFecha(libro.fechaInicioLectura)}}</span>
                          </div>
                          <!-- Barra de progreso de lectura -->
                          <div class="progress-container">
                              <div class="progress">
                                  <div class="progress-bar bg-primary" role="progressbar" 
                                       [style.width.%]="calcularProgreso(libro.paginasLeidas, libro.numeroPaginas)" 
                                       aria-valuemin="0" aria-valuemax="100" 
                                       [attr.aria-valuenow]="calcularProgreso(libro.paginasLeidas, libro.numeroPaginas)">
                                  </div>
                              </div>
                              <span class="progress-text">
                                  {{calcularProgreso(libro.paginasLeidas, libro.numeroPaginas)}}% completado
                                  <span class="pages-text" *ngIf="libro.numeroPaginas">
                                      ({{libro.paginasLeidas || 0}}/{{libro.numeroPaginas}} páginas)
                                  </span>
                              </span>
                          </div>
                          <!-- Notas del usuario -->
                          <div class="libro-notas mt-2" *ngIf="libro.comentario">
                              <div class="notas-header">
                                  <span class="material-icons">note</span>
                                  <span class="notas-titulo">Notas:</span>
                              </div>
                              <p class="notas-texto">{{truncarTexto(libro.comentario, 120)}}</p>
                          </div>
                      </div>
                      <div class="libro-actions">
                          <button class="btn btn-icon" title="Editar" (click)="editarLibro(libro)">
                              <span class="material-icons">edit</span>
                          </button>
                          <button class="btn btn-icon" title="Eliminar" (click)="eliminarDeColeccion(libro)">
                              <span class="material-icons">delete</span>
                          </button>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- Sección de libros pendientes por leer -->
  <div *ngIf="(filtroActual === 'pendientes') && librosPendientes.length > 0" class="biblioteca-section" 
       role="tabpanel" 
       id="seccion-pendientes" 
       aria-labelledby="tab-pendientes">
      <div class="section-header">
          <h2 class="section-title">
            <span class="material-icons section-icon">bookmark</span>
            Pendientes por leer
          </h2>
          <span class="section-count">{{librosPendientes.length}} {{librosPendientes.length === 1 ? 'libro' : 'libros'}}</span>
      </div>
      <div class="libros-grid">
          <div class="libro-item" *ngFor="let libro of librosPendientes">
              <div class="libro-card">
                  <div class="libro-img-container">
                      <img [src]="getImageUrl(libro.portadaUrl)" 
                           class="libro-portada" alt="Portada del libro {{libro.titulo}}">
                      <div class="libro-overlay">
                          <div class="libro-estado-badge" [ngClass]="getColorEstado('PENDIENTE')">
                              <span class="material-icons estado-icon">bookmark</span>
                              <span>Por leer</span>
                          </div>
                      </div>
                  </div>
                  <div class="libro-info">
                      <h5 class="libro-titulo">{{libro.titulo}}</h5>
                      <div class="libro-autor">
                          <span class="material-icons autor-icon">person</span>
                          <span>{{libro.autor?.nombre}} {{libro.autor?.apellido}}</span>
                      </div>
                      <!-- Barra de progreso para libros pendientes -->
                      <div class="progress-container" *ngIf="libro.numeroPaginas">
                          <div class="progress">
                              <div class="progress-bar bg-warning" role="progressbar" 
                                   [style.width.%]="calcularProgreso(libro.paginasLeidas, libro.numeroPaginas)" 
                                   aria-valuemin="0" aria-valuemax="100" 
                                   [attr.aria-valuenow]="calcularProgreso(libro.paginasLeidas, libro.numeroPaginas)">
                              </div>
                          </div>
                          <span class="progress-text">
                              {{calcularProgreso(libro.paginasLeidas, libro.numeroPaginas)}}% completado
                              <span class="pages-text">
                                  ({{libro.paginasLeidas || 0}}/{{libro.numeroPaginas}} páginas)
                              </span>
                          </span>
                      </div>
                      <!-- Notas del usuario -->
                      <div class="libro-notas mt-2" *ngIf="libro.comentario">
                          <div class="notas-header">
                              <span class="material-icons">note</span>
                              <span class="notas-titulo">Notas:</span>
                          </div>
                          <p class="notas-texto">{{truncarTexto(libro.comentario, 120)}}</p>
                      </div>
                      <div class="libro-actions">
                          <button class="btn btn-icon" title="Editar" (click)="editarLibro(libro)">
                              <span class="material-icons">edit</span>
                          </button>
                          <button class="btn btn-icon" title="Eliminar" (click)="eliminarDeColeccion(libro)">
                              <span class="material-icons">delete</span>
                          </button>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- Sección de libros terminados -->
  <div *ngIf="(filtroActual === 'terminados') && librosTerminados.length > 0" class="biblioteca-section" 
       role="tabpanel" 
       id="seccion-terminados" 
       aria-labelledby="tab-terminados">
      <div class="section-header">
          <h2 class="section-title">
            <span class="material-icons section-icon">check_circle</span>
            Libros leídos
          </h2>
          <span class="section-count">{{librosTerminados.length}} {{librosTerminados.length === 1 ? 'libro' : 'libros'}}</span>
      </div>
      <div class="libros-grid">
          <div class="libro-item" *ngFor="let libro of librosTerminados">
              <div class="libro-card">
                  <div class="libro-img-container">
                      <img [src]="getImageUrl(libro.portadaUrl)" 
                           class="libro-portada" alt="Portada del libro {{libro.titulo}}">
                      <div class="libro-overlay">
                          <div class="libro-estado-badge" [ngClass]="getColorEstado('TERMINADO')">
                              <span class="material-icons estado-icon">check_circle</span>
                              <span>Leído</span>
                          </div>
                          <div *ngIf="libro.valoracion" class="libro-valoracion">
                              <span class="stars-rating">
                                  <span *ngFor="let star of estrellasPorValoracion(libro.valoracion)">★</span>
                              </span>
                          </div>
                      </div>
                  </div>
                  <div class="libro-info">
                      <h5 class="libro-titulo">{{libro.titulo}}</h5>
                      <div class="libro-autor">
                          <span class="material-icons autor-icon">person</span>
                          <span>{{libro.autor?.nombre}} {{libro.autor?.apellido}}</span>
                      </div>
                      <div class="libro-meta">
                          <div class="meta-item">
                              <span class="meta-label">Terminado:</span>
                              <span class="meta-value">{{formatearFecha(libro.fechaFinLectura)}}</span>
                          </div>
                      </div>
                      <!-- Notas del usuario -->
                      <div class="libro-notas mt-2" *ngIf="libro.comentario">
                          <div class="notas-header">
                              <span class="material-icons">note</span>
                              <span class="notas-titulo">Notas:</span>
                          </div>
                          <p class="notas-texto">{{truncarTexto(libro.comentario, 120)}}</p>
                      </div>
                      <div class="libro-actions">
                          <button class="btn btn-icon" title="Editar" (click)="editarLibro(libro)">
                              <span class="material-icons">edit</span>
                          </button>
                          <button class="btn btn-icon" title="Eliminar" (click)="eliminarDeColeccion(libro)">
                              <span class="material-icons">delete</span>
                          </button>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- Sección de libros abandonados -->
  <div *ngIf="(filtroActual === 'abandonados') && librosAbandonados.length > 0" class="biblioteca-section"
       role="tabpanel" 
       id="seccion-abandonados" 
       aria-labelledby="tab-abandonados">
      <div class="section-header">
          <h2 class="section-title">
            <span class="material-icons section-icon">cancel</span>
            Libros abandonados
          </h2>
          <span class="section-count">{{librosAbandonados.length}} {{librosAbandonados.length === 1 ? 'libro' : 'libros'}}</span>
      </div>
      <div class="libros-grid">
          <div class="libro-item" *ngFor="let libro of librosAbandonados">
              <div class="libro-card">
                  <div class="libro-img-container">
                      <img [src]="getImageUrl(libro.portadaUrl)" 
                           class="libro-portada" alt="Portada del libro {{libro.titulo}}">
                      <div class="libro-overlay">
                          <div class="libro-estado-badge" [ngClass]="getColorEstado('ABANDONADO')">
                              <span class="material-icons estado-icon">cancel</span>
                              <span>Abandonado</span>
                          </div>
                      </div>
                  </div>
                  <div class="libro-info">
                      <h5 class="libro-titulo">{{libro.titulo}}</h5>
                      <div class="libro-autor">
                          <span class="material-icons autor-icon">person</span>
                          <span>{{libro.autor?.nombre}} {{libro.autor?.apellido}}</span>
                      </div>
                      <!-- Notas del usuario -->
                      <div class="libro-notas mt-2" *ngIf="libro.comentario">
                          <div class="notas-header">
                              <span class="material-icons">note</span>
                              <span class="notas-titulo">Notas:</span>
                          </div>
                          <p class="notas-texto">{{truncarTexto(libro.comentario, 120)}}</p>
                      </div>
                      <div class="libro-actions">
                          <button class="btn btn-icon" title="Editar" (click)="editarLibro(libro)">
                              <span class="material-icons">edit</span>
                          </button>
                          <button class="btn btn-icon" title="Eliminar" (click)="eliminarDeColeccion(libro)">
                              <span class="material-icons">delete</span>
                          </button>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>
</div>

<!-- Modal de edición de estado de lectura -->
<div *ngIf="mostrarEdicion" class="modal-custom-backdrop">
    <div class="modal-custom-container">
        <div class="modal-custom-content">
            <div class="modal-custom-header">
                <h5 class="modal-title">
                    <span class="material-icons me-2">edit</span>
                    Editar estado de lectura
                </h5>
                <button type="button" class="modal-close-btn" (click)="cerrarEdicion()">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-custom-body">
                <div class="form-group">
                    <label for="estadoLectura" class="form-label">Estado de lectura</label>
                    <select class="form-select" id="estadoLectura" [(ngModel)]="libroSeleccionado.estadoLectura">
                        <option *ngFor="let estado of estadosLectura" [value]="estado.valor">{{estado.etiqueta}}</option>
                    </select>
                </div>

                <div class="form-group" *ngIf="libroSeleccionado?.estadoLectura === 'TERMINADO'">
                    <label for="valoracion" class="form-label">Valoración</label>
                    <select class="form-select" id="valoracion" [(ngModel)]="libroSeleccionado.valoracion">
                        <option [ngValue]="null">Sin valoración</option>
                        <option [value]="1">1 ★</option>
                        <option [value]="2">2 ★★</option>
                        <option [value]="3">3 ★★★</option>
                        <option [value]="4">4 ★★★★</option>
                        <option [value]="5">5 ★★★★★</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="fechaInicioLectura" class="form-label">Fecha de inicio de lectura</label>
                    <input type="date" class="form-control" id="fechaInicioLectura" 
                           [(ngModel)]="libroSeleccionado.fechaInicioLectura"
                           [max]="fechaActual"
                           #fechaInicio="ngModel"
                           required>
                    <div *ngIf="fechaInicio.invalid && (fechaInicio.dirty || fechaInicio.touched)" class="text-danger form-error">
                        <small *ngIf="fechaInicio.errors?.['required']">La fecha de inicio es obligatoria</small>
                        <small *ngIf="fechaInicio.errors?.['max']">La fecha de inicio no puede ser posterior a la fecha actual</small>
                    </div>
                </div>

                <div class="form-group" *ngIf="libroSeleccionado?.estadoLectura === 'TERMINADO' || libroSeleccionado?.estadoLectura === 'ABANDONADO'">
                    <label for="fechaFinLectura" class="form-label">Fecha de finalización</label>
                    <input type="date" class="form-control" id="fechaFinLectura" 
                           [(ngModel)]="libroSeleccionado.fechaFinLectura"
                           [min]="libroSeleccionado.fechaInicioLectura"
                           [max]="fechaActual"
                           #fechaFin="ngModel"
                           required>
                    <div *ngIf="fechaFin.invalid && (fechaFin.dirty || fechaFin.touched)" class="text-danger form-error">
                        <small *ngIf="fechaFin.errors?.['required']">La fecha de finalización es obligatoria</small>
                        <small *ngIf="fechaFin.errors?.['min']">La fecha de finalización no puede ser anterior a la fecha de inicio</small>
                        <small *ngIf="fechaFin.errors?.['max']">La fecha de finalización no puede ser posterior a la fecha actual</small>
                    </div>
                </div>

                <div class="form-group" *ngIf="libroSeleccionado?.numeroPaginas && (libroSeleccionado?.estadoLectura === 'LEYENDO' || libroSeleccionado?.estadoLectura === 'PENDIENTE' || libroSeleccionado?.estadoLectura === 'TERMINADO')">
                    <label for="paginasLeidas" class="form-label">Páginas leídas (de {{libroSeleccionado?.numeroPaginas}})</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="paginasLeidas"
                               [(ngModel)]="libroSeleccionado.paginasLeidas"
                               name="paginasLeidas"
                               #paginasLeidas="ngModel"
                               [min]="0" [max]="libroSeleccionado.numeroPaginas"
                               required
                               placeholder="0">
                        <span class="input-group-text">de {{libroSeleccionado?.numeroPaginas}} páginas</span>
                    </div>
                    <div *ngIf="paginasLeidas.invalid && (paginasLeidas.dirty || paginasLeidas.touched)" class="text-danger form-error">
                        <small *ngIf="paginasLeidas.errors?.['required']">El número de páginas leídas es obligatorio</small>
                        <small *ngIf="paginasLeidas.errors?.['min']">El número de páginas leídas debe ser al menos 0</small>
                        <small *ngIf="paginasLeidas.errors?.['max']">El número de páginas leídas no puede ser mayor que el total de páginas</small>
                    </div>
                    
                    <!-- Barra de progreso interactiva -->
                    <div class="progress-interactive mt-3">
                        <div class="progress-bar-container">
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" 
                                     [style.width.%]="calcularProgreso(libroSeleccionado?.paginasLeidas, libroSeleccionado?.numeroPaginas)" 
                                     [attr.aria-valuenow]="calcularProgreso(libroSeleccionado?.paginasLeidas, libroSeleccionado?.numeroPaginas)"
                                     aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                            <input type="range" class="progress-slider" 
                                  [min]="0" [max]="libroSeleccionado.numeroPaginas || 100" 
                                  [(ngModel)]="libroSeleccionado.paginasLeidas"
                                  (change)="actualizarProgresoBarra()"
                                  aria-labelledby="paginasLeidas">
                        </div>
                        <div class="progress-info">
                            <span class="progress-percentage">{{calcularProgreso(libroSeleccionado?.paginasLeidas, libroSeleccionado?.numeroPaginas)}}%</span>
                            <span class="progress-pages">{{libroSeleccionado?.paginasLeidas || 0}} de {{libroSeleccionado?.numeroPaginas}} páginas</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="comentario" class="form-label">Comentarios</label>
                    <textarea class="form-control" id="comentario" rows="4"
                              [(ngModel)]="libroSeleccionado.comentario"
                              placeholder="Escribe tus impresiones sobre el libro..."></textarea>
                </div>
            </div>
            <div class="modal-custom-footer">
                <button type="button" class="btn btn-outline-secondary" (click)="cerrarEdicion()">
                    <span class="material-icons me-1">close</span>
                    Cancelar
                </button>
                <button type="button" 
                       class="btn btn-primary" 
                       [disabled]="!formularioValido()"
                       (click)="confirmarActualizacion()">
                    <span class="material-icons me-1">save</span>
                    Guardar cambios
                </button>
            </div>
        </div>
    </div>
</div>
