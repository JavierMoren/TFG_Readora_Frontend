<div class="container biblioteca-container">
    <h1 class="display-5 fw-bold mb-4">Mi Biblioteca Personal</h1>

    <!-- Filtros para seleccionar quÃ© libros mostrar -->
    <div class="filtros-container">
        <div class="d-flex flex-wrap justify-content-center justify-content-md-start">
            <button type="button" class="filtro-btn" 
                [class.btn-primary]="filtroActual === 'todos'" 
                [class.btn-outline-primary]="filtroActual !== 'todos'"
                (click)="cambiarFiltro('todos')">
                Todos
            </button>
            <button type="button" class="filtro-btn" 
                [class.btn-primary]="filtroActual === 'leyendo'" 
                [class.btn-outline-primary]="filtroActual !== 'leyendo'"
                (click)="cambiarFiltro('leyendo')">
                Leyendo 
                <span class="filtro-btn-count">{{librosLeyendo.length}}</span>
            </button>
            <button type="button" class="filtro-btn" 
                [class.btn-primary]="filtroActual === 'pendientes'" 
                [class.btn-outline-primary]="filtroActual !== 'pendientes'"
                (click)="cambiarFiltro('pendientes')">
                Por leer 
                <span class="filtro-btn-count">{{librosPendientes.length}}</span>
            </button>
            <button type="button" class="filtro-btn" 
                [class.btn-primary]="filtroActual === 'terminados'" 
                [class.btn-outline-primary]="filtroActual !== 'terminados'"
                (click)="cambiarFiltro('terminados')">
                LeÃ­dos 
                <span class="filtro-btn-count">{{librosTerminados.length}}</span>
            </button>
            <button type="button" class="filtro-btn" 
                [class.btn-primary]="filtroActual === 'abandonados'" 
                [class.btn-outline-primary]="filtroActual !== 'abandonados'"
                (click)="cambiarFiltro('abandonados')">
                Abandonados 
                <span class="filtro-btn-count">{{librosAbandonados.length}}</span>
            </button>
        </div>
    </div>

    <!-- Mensaje cuando no hay libros -->
    <div *ngIf="!librosLeyendo.length && !librosPendientes.length && !librosTerminados.length && !librosAbandonados.length"
         class="sin-libros">
        <div class="sin-libros-icon">ðŸ“š</div>
        <h3>Tu biblioteca estÃ¡ vacÃ­a</h3>
        <p class="text-muted">
            No tienes libros en tu biblioteca personal. 
            Utiliza el buscador para encontrar libros y aÃ±adirlos a tu colecciÃ³n.
        </p>
    </div>
    
    <!-- Indicador de carga -->
    <div *ngIf="cargando" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2">Cargando tu biblioteca...</p>
    </div>

    <!-- SecciÃ³n de libros que estoy leyendo -->
    <div *ngIf="(filtroActual === 'todos' || filtroActual === 'leyendo') && librosLeyendo.length > 0" class="mb-5">
        <h2 class="seccion-titulo">Estoy leyendo</h2>
        <div class="libros-grid">
            <div class="libro-item" *ngFor="let libro of librosLeyendo">
                <div class="libro-card">
                    <div class="libro-img-container">
                        <img [src]="libro.portadaUrl ? storageService.getFullImageUrl(libro.portadaUrl) : libroPlaceholder" 
                             class="book-cover-biblioteca" alt="Portada del libro {{libro.titulo}}">
                        <span class="libro-estado" [ngClass]="getColorEstado('LEYENDO')">
                            Leyendo
                        </span>
                    </div>
                    <div class="libro-info">
                        <h5 class="libro-titulo">{{libro.titulo}}</h5>
                        <p class="libro-autor">{{libro.autor?.nombre}} {{libro.autor?.apellido}}</p>
                        <p class="libro-meta">
                            <strong>Inicio lectura:</strong> {{formatearFecha(libro.fechaInicioLectura)}}
                        </p>
                        <div class="libro-actions">
                            <button class="btn btn-sm btn-outline-primary" (click)="editarLibro(libro)">
                                <i class="bi bi-pencil-fill me-1"></i> Editar
                            </button>
                            <button class="btn btn-sm btn-outline-danger" (click)="eliminarDeColeccion(libro)">
                                <i class="bi bi-trash-fill me-1"></i> Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SecciÃ³n de libros pendientes por leer -->
    <div *ngIf="(filtroActual === 'todos' || filtroActual === 'pendientes') && librosPendientes.length > 0" class="mb-5">
        <h2 class="seccion-titulo">Pendientes por leer</h2>
        <div class="libros-grid">
            <div class="libro-item" *ngFor="let libro of librosPendientes">
                <div class="libro-card">
                    <div class="libro-img-container">
                        <img [src]="libro.portadaUrl ? storageService.getFullImageUrl(libro.portadaUrl) : libroPlaceholder" 
                             class="book-cover-biblioteca" alt="Portada del libro {{libro.titulo}}">
                        <span class="libro-estado" [ngClass]="getColorEstado('PENDIENTE')">
                            Por leer
                        </span>
                    </div>
                    <div class="libro-info">
                        <h5 class="libro-titulo">{{libro.titulo}}</h5>
                        <p class="libro-autor">{{libro.autor?.nombre}} {{libro.autor?.apellido}}</p>
                        <div class="libro-actions">
                            <button class="btn btn-sm btn-outline-primary" (click)="editarLibro(libro)">
                                <i class="bi bi-pencil-fill me-1"></i> Editar
                            </button>
                            <button class="btn btn-sm btn-outline-danger" (click)="eliminarDeColeccion(libro)">
                                <i class="bi bi-trash-fill me-1"></i> Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SecciÃ³n de libros terminados -->
    <div *ngIf="(filtroActual === 'todos' || filtroActual === 'terminados') && librosTerminados.length > 0" class="mb-5">
        <h2 class="seccion-titulo">Libros leÃ­dos</h2>
        <div class="libros-grid">
            <div class="libro-item" *ngFor="let libro of librosTerminados">
                <div class="libro-card">
                    <div class="libro-img-container">
                        <img [src]="libro.portadaUrl ? storageService.getFullImageUrl(libro.portadaUrl) : libroPlaceholder" 
                             class="book-cover-biblioteca" alt="Portada del libro {{libro.titulo}}">
                        <span class="libro-estado" [ngClass]="getColorEstado('TERMINADO')">
                            LeÃ­do
                        </span>
                    </div>
                    <div class="libro-info">
                        <h5 class="libro-titulo">{{libro.titulo}}</h5>
                        <p class="libro-autor">{{libro.autor?.nombre}} {{libro.autor?.apellido}}</p>
                        <div *ngIf="libro.valoracion" class="libro-valoracion">
                            <strong>ValoraciÃ³n:</strong> 
                            <span class="star-rating">
                                <span *ngFor="let star of estrellasPorValoracion(libro.valoracion)">â˜…</span>
                            </span>
                        </div>
                        <p class="libro-meta">
                            <strong>Terminado:</strong> {{formatearFecha(libro.fechaFinLectura)}}
                        </p>
                        <p *ngIf="libro.comentario" class="libro-comentario">
                            "{{truncarTexto(libro.comentario, 150)}}"
                        </p>
                        <div class="libro-actions">
                            <button class="btn btn-sm btn-outline-primary" (click)="editarLibro(libro)">
                                <i class="bi bi-pencil-fill me-1"></i> Editar
                            </button>
                            <button class="btn btn-sm btn-outline-danger" (click)="eliminarDeColeccion(libro)">
                                <i class="bi bi-trash-fill me-1"></i> Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SecciÃ³n de libros abandonados -->
    <div *ngIf="(filtroActual === 'todos' || filtroActual === 'abandonados') && librosAbandonados.length > 0" class="mb-5">
        <h2 class="seccion-titulo">Libros abandonados</h2>
        <div class="libros-grid">
            <div class="libro-item" *ngFor="let libro of librosAbandonados">
                <div class="libro-card">
                    <div class="libro-img-container">
                        <img [src]="libro.portadaUrl ? storageService.getFullImageUrl(libro.portadaUrl) : libroPlaceholder" 
                             class="book-cover-biblioteca" alt="Portada del libro {{libro.titulo}}">
                        <span class="libro-estado" [ngClass]="getColorEstado('ABANDONADO')">
                            Abandonado
                        </span>
                    </div>
                    <div class="libro-info">
                        <h5 class="libro-titulo">{{libro.titulo}}</h5>
                        <p class="libro-autor">{{libro.autor?.nombre}} {{libro.autor?.apellido}}</p>
                        <p *ngIf="libro.comentario" class="libro-comentario">
                            "{{truncarTexto(libro.comentario, 150)}}"
                        </p>
                        <div class="libro-actions">
                            <button class="btn btn-sm btn-outline-primary" (click)="editarLibro(libro)">
                                <i class="bi bi-pencil-fill me-1"></i> Editar
                            </button>
                            <button class="btn btn-sm btn-outline-danger" (click)="eliminarDeColeccion(libro)">
                                <i class="bi bi-trash-fill me-1"></i> Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de ediciÃ³n de estado de lectura -->
<div *ngIf="mostrarEdicion" class="modal d-block modal-custom" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar estado de lectura</h5>
                <button type="button" class="btn-close" (click)="cerrarEdicion()"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="estadoLectura" class="form-label">Estado de lectura</label>
                    <select class="form-select" id="estadoLectura" [(ngModel)]="libroSeleccionado.estadoLectura">
                        <option *ngFor="let estado of estadosLectura" [value]="estado.valor">{{estado.etiqueta}}</option>
                    </select>
                </div>

                <div class="mb-3" *ngIf="libroSeleccionado?.estadoLectura === 'TERMINADO'">
                    <label for="valoracion" class="form-label">ValoraciÃ³n</label>
                    <select class="form-select" id="valoracion" [(ngModel)]="libroSeleccionado.valoracion">
                        <option [ngValue]="null">Sin valoraciÃ³n</option>
                        <option [value]="1">1 â˜…</option>
                        <option [value]="2">2 â˜…â˜…</option>
                        <option [value]="3">3 â˜…â˜…â˜…</option>
                        <option [value]="4">4 â˜…â˜…â˜…â˜…</option>
                        <option [value]="5">5 â˜…â˜…â˜…â˜…â˜…</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="fechaInicioLectura" class="form-label">Fecha de inicio de lectura</label>
                    <input type="date" class="form-control" id="fechaInicioLectura" 
                           [(ngModel)]="libroSeleccionado.fechaInicioLectura">
                </div>

                <div class="mb-3" *ngIf="libroSeleccionado?.estadoLectura === 'TERMINADO' || libroSeleccionado?.estadoLectura === 'ABANDONADO'">
                    <label for="fechaFinLectura" class="form-label">Fecha de finalizaciÃ³n</label>
                    <input type="date" class="form-control" id="fechaFinLectura" 
                           [(ngModel)]="libroSeleccionado.fechaFinLectura">
                </div>

                <div class="mb-3">
                    <label for="comentario" class="form-label">Comentarios</label>
                    <textarea class="form-control" id="comentario" rows="3"
                              [(ngModel)]="libroSeleccionado.comentario"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="cerrarEdicion()">Cancelar</button>
                <button type="button" class="btn btn-primary" (click)="actualizarEstadoLectura()">Guardar cambios</button>
            </div>
        </div>
    </div>
</div>
